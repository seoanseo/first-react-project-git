"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.checkGitInclusion = exports.checkAndAddConfigToGitignore = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = __importDefault(require("path"));
const git_1 = require("../utils/git");
const config_1 = require("../constants/config");
const lang_1 = require("../utils/lang");
const i18nKey = 'lib.gitignore';
const GITIGNORE_FILE = '.gitignore';
function checkAndAddConfigToGitignore(configPath) {
    try {
        const { configIgnored, gitignoreFiles } = checkGitInclusion(configPath);
        if (configIgnored)
            return;
        let gitignoreFilePath = gitignoreFiles && gitignoreFiles.length ? gitignoreFiles[0] : null;
        if (!gitignoreFilePath) {
            gitignoreFilePath = path_1.default.resolve(configPath, GITIGNORE_FILE);
            (0, fs_extra_1.writeFileSync)(gitignoreFilePath, '');
        }
        const gitignoreContents = (0, fs_extra_1.readFileSync)(gitignoreFilePath).toString();
        const updatedContents = `${gitignoreContents.trim()}\n\n# HubSpot config file\n${config_1.DEFAULT_HUBSPOT_CONFIG_YAML_FILE_NAME}\n`;
        (0, fs_extra_1.writeFileSync)(gitignoreFilePath, updatedContents);
    }
    catch (e) {
        throw new Error((0, lang_1.i18n)(`${i18nKey}.errors.configIgnore`), { cause: e });
    }
}
exports.checkAndAddConfigToGitignore = checkAndAddConfigToGitignore;
function checkGitInclusion(configPath) {
    const result = {
        inGit: false,
        configIgnored: false,
        gitignoreFiles: [],
    };
    if ((0, git_1.isConfigPathInGitRepo)(configPath)) {
        result.inGit = true;
        result.gitignoreFiles = (0, git_1.getGitignoreFiles)(configPath);
        if ((0, git_1.configFilenameIsIgnoredByGitignore)(result.gitignoreFiles, configPath)) {
            // Found ignore statement in .gitignore that matches config filename
            result.configIgnored = true;
        }
    }
    return result;
}
exports.checkGitInclusion = checkGitInclusion;
